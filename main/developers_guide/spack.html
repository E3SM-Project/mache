

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding Spack Support for a New Machine</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=a8da1a53"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Building the Documentation" href="building_docs.html" />
    <link rel="prev" title="Adding a New Machine to Mache" href="adding_new_machine.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Mache
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/spack/build.html">Building and Using Spack Environments with <code class="docutils literal notranslate"><span class="pre">mache.spack</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to mache</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding_new_machine.html">Adding a New Machine to Mache</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adding Spack Support for a New Machine</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#yaml-template-files">YAML Template Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#typical-external-packages">Typical External Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finding-library-paths">Finding Library Paths</a></li>
<li class="toctree-l3"><a class="reference internal" href="#marking-packages-as-non-buildable">Marking Packages as Non-Buildable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#providers">Providers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#automatic-shell-script-generation-preferred">Automatic shell script generation (preferred)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#when-to-add-a-template-override">When to add a template override</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="building_docs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_docs.html#previewing-the-documentation">Previewing the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasing.html">Releasing a New Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mache</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Adding Spack Support for a New Machine</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developers_guide/spack.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="adding-spack-support-for-a-new-machine">
<h1>Adding Spack Support for a New Machine<a class="headerlink" href="#adding-spack-support-for-a-new-machine" title="Link to this heading"></a></h1>
<p>This guide describes how to add support for a new machine to the <code class="docutils literal notranslate"><span class="pre">mache.spack</span></code>
subpackage, focusing on the YAML configuration files for compilers and MPI
libraries. For instructions on adding a new machine to mache in general
(including non-spack configuration), see
<a class="reference internal" href="adding_new_machine.html"><span class="std std-doc">Adding a New Machine to Mache</span></a>.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>To enable Spack-based environments for a new machine, you will need to:</p>
<ol class="arabic simple">
<li><p>Create one or more YAML template files in <code class="docutils literal notranslate"><span class="pre">mache/spack/templates/</span></code> for each
supported compiler and MPI library combination.</p></li>
<li><p>Add system-provided (external) packages, saving time and preventing build
failures if Spack attempts to build them from source.</p></li>
<li><p>Prefer automatic shell script generation. Shell snippets used to be
maintained as templates in <code class="docutils literal notranslate"><span class="pre">mache.spack.templates</span></code>, but are now derived
primarily from the E3SM CIME machine configuration
(<code class="docutils literal notranslate"><span class="pre">mache/cime_machine_config/config_machines.xml</span></code>). Only add a minimal
template override when strictly necessary (see below).</p></li>
</ol>
</section>
<section id="yaml-template-files">
<h2>YAML Template Files<a class="headerlink" href="#yaml-template-files" title="Link to this heading"></a></h2>
<p>Each YAML file describes a Spack environment for a particular combination of compiler and MPI library. The filename convention is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">machine</span><span class="o">&gt;</span><span class="n">_</span><span class="o">&lt;</span><span class="n">compiler</span><span class="o">&gt;</span><span class="n">_</span><span class="o">&lt;</span><span class="n">mpilib</span><span class="o">&gt;.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>For example: <code class="docutils literal notranslate"><span class="pre">chicoma-cpu_gnu_mpich.yaml</span></code></p>
<p>These files are Jinja2 templates, allowing conditional inclusion of packages
(e.g., HDF5/NetCDF, LAPACK) based on user options.</p>
<section id="typical-external-packages">
<h3>Typical External Packages<a class="headerlink" href="#typical-external-packages" title="Link to this heading"></a></h3>
<p>On most HPC systems, the following packages are provided by the system and
should be marked as <code class="docutils literal notranslate"><span class="pre">external</span></code> in the YAML:</p>
<ul class="simple">
<li><p>Compilers (e.g., <code class="docutils literal notranslate"><span class="pre">gcc</span></code>, <code class="docutils literal notranslate"><span class="pre">intel</span></code>, <code class="docutils literal notranslate"><span class="pre">nvhpc</span></code>, <code class="docutils literal notranslate"><span class="pre">rocmcc</span></code>, <code class="docutils literal notranslate"><span class="pre">oneapi</span></code>)</p></li>
<li><p>MPI libraries (e.g., <code class="docutils literal notranslate"><span class="pre">cray-mpich</span></code>, <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>, <code class="docutils literal notranslate"><span class="pre">mvapich2</span></code>, <code class="docutils literal notranslate"><span class="pre">intel-mpi</span></code>,
<code class="docutils literal notranslate"><span class="pre">mpich</span></code>)</p></li>
<li><p>BLAS/LAPACK libraries (e.g., <code class="docutils literal notranslate"><span class="pre">cray-libsci</span></code>, <code class="docutils literal notranslate"><span class="pre">intel-mkl</span></code>, <code class="docutils literal notranslate"><span class="pre">intel-oneapi-mkl</span></code>)</p></li>
<li><p>HDF5, NetCDF, and PNetCDF libraries (often as modules or in system paths)</p></li>
<li><p>Build tools: <code class="docutils literal notranslate"><span class="pre">cmake</span></code>, <code class="docutils literal notranslate"><span class="pre">gmake</span></code>, <code class="docutils literal notranslate"><span class="pre">autoconf</span></code>, <code class="docutils literal notranslate"><span class="pre">automake</span></code>, <code class="docutils literal notranslate"><span class="pre">libtool</span></code>, <code class="docutils literal notranslate"><span class="pre">m4</span></code></p></li>
<li><p>Compression and utility libraries: <code class="docutils literal notranslate"><span class="pre">bzip2</span></code>, <code class="docutils literal notranslate"><span class="pre">xz</span></code>, <code class="docutils literal notranslate"><span class="pre">zlib</span></code>, <code class="docutils literal notranslate"><span class="pre">curl</span></code>, <code class="docutils literal notranslate"><span class="pre">openssl</span></code>,
<code class="docutils literal notranslate"><span class="pre">findutils</span></code>, <code class="docutils literal notranslate"><span class="pre">gettext</span></code>, <code class="docutils literal notranslate"><span class="pre">tar</span></code>, <code class="docutils literal notranslate"><span class="pre">perl</span></code>, <code class="docutils literal notranslate"><span class="pre">python</span></code></p></li>
</ul>
<p><strong>Note:</strong> The exact set of external packages may vary by machine. Consult existing YAML files for examples.</p>
</section>
<section id="finding-library-paths">
<h3>Finding Library Paths<a class="headerlink" href="#finding-library-paths" title="Link to this heading"></a></h3>
<p>To specify an external package, you need its installation prefix and (optionally) the module name. You can find these by:</p>
<ul class="simple">
<li><p>Using <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">&lt;executable&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">$MODULEPATH</span></code> to find module paths</p></li>
<li><p>Checking the output of <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">show</span> <span class="pre">&lt;modulename&gt;</span></code> for environment variables like <code class="docutils literal notranslate"><span class="pre">PATH</span></code>, <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code>, or <code class="docutils literal notranslate"><span class="pre">PREFIX</span></code></p></li>
<li><p>Consulting system documentation or sysadmins</p></li>
</ul>
<p>Example external package entry:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cmake</span><span class="p">:</span>
<span class="w">  </span><span class="nt">externals</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake@3.27.9</span>
<span class="w">    </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sw/frontier/spack-envs/core-24.07/opt/gcc-7.5.0/cmake-3.27.9-pyxnvhiskwepbw5itqyipzyhhfw3yitk</span>
<span class="w">    </span><span class="nt">modules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake/3.27.9</span>
<span class="w">  </span><span class="nt">buildable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</section>
<section id="marking-packages-as-non-buildable">
<h3>Marking Packages as Non-Buildable<a class="headerlink" href="#marking-packages-as-non-buildable" title="Link to this heading"></a></h3>
<p>For each external package, set <code class="docutils literal notranslate"><span class="pre">buildable:</span> <span class="pre">false</span></code> to prevent Spack from attempting to build it from source.</p>
</section>
<section id="providers">
<h3>Providers<a class="headerlink" href="#providers" title="Link to this heading"></a></h3>
<p>Specify providers for <code class="docutils literal notranslate"><span class="pre">mpi</span></code> and <code class="docutils literal notranslate"><span class="pre">lapack</span></code> under the <code class="docutils literal notranslate"><span class="pre">all</span></code> section, e.g.:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">all</span><span class="p">:</span>
<span class="w">  </span><span class="nt">compiler</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">gcc@13.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">providers</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mpi</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">cray-mpich@8.1.31%gcc@13.2</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">lapack</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">cray-libsci@24.11.0</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
</section>
<section id="automatic-shell-script-generation-preferred">
<h2>Automatic shell script generation (preferred)<a class="headerlink" href="#automatic-shell-script-generation-preferred" title="Link to this heading"></a></h2>
<p>When downstream packages call
<a class="reference internal" href="generated/mache.spack.get_spack_script.html#mache.spack.get_spack_script" title="mache.spack.get_spack_script"><code class="xref py py-func docutils literal notranslate"><span class="pre">mache.spack.get_spack_script()</span></code></a>, the module loads and
environment-variable setup are constructed as follows:</p>
<ol class="arabic simple">
<li><p>Optional: activate Spack and the requested environment.</p></li>
<li><p>Auto-generate a shell snippet from the E3SM CIME machine configuration
stored in <code class="docutils literal notranslate"><span class="pre">mache/cime_machine_config/config_machines.xml</span></code>, filtered for the
requested <code class="docutils literal notranslate"><span class="pre">(machine,</span> <span class="pre">compiler,</span> <span class="pre">mpilib)</span></code> and rendered for the target shell
(<code class="docutils literal notranslate"><span class="pre">sh</span></code> or <code class="docutils literal notranslate"><span class="pre">csh</span></code>).</p></li>
<li><p>Append any Jinja2 template override found in
<code class="docutils literal notranslate"><span class="pre">mache/spack/templates/</span></code> named either <code class="docutils literal notranslate"><span class="pre">&lt;machine&gt;.&lt;sh|csh&gt;</span></code> or
<code class="docutils literal notranslate"><span class="pre">&lt;machine&gt;_&lt;compiler&gt;_&lt;mpilib&gt;.&lt;sh|csh&gt;</span></code>.</p></li>
</ol>
<p>This pipeline greatly reduces maintenance and prevents drift between Mache and
E3SM’s authoritative machine configuration. In most cases, you do not need to
author or maintain shell script templates in Mache.</p>
<section id="when-to-add-a-template-override">
<h3>When to add a template override<a class="headerlink" href="#when-to-add-a-template-override" title="Link to this heading"></a></h3>
<p>Only provide a small override in <code class="docutils literal notranslate"><span class="pre">mache/spack/templates/</span></code> if you need to:</p>
<ul class="simple">
<li><p>Apply an adjustment that’s not appropriate for the shared E3SM CIME config
(machine-local quirk, temporary workaround, etc.).</p></li>
<li><p>Add conditional behavior toggled by
<code class="docutils literal notranslate"><span class="pre">include_e3sm_lapack</span></code> or <code class="docutils literal notranslate"><span class="pre">include_e3sm_hdf5_netcdf</span></code> (both exposed as Jinja
booleans in templates) that cannot be expressed in the CIME config.</p></li>
</ul>
<p>Templates are Jinja2 files and can use the same conditional logic as YAML
templates.</p>
</section>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Link to this heading"></a></h2>
<p>After adding or modifying YAML templates (or an exceptional shell override):</p>
<ol class="arabic simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">make_spack_env</span></code> or <code class="docutils literal notranslate"><span class="pre">get_spack_script</span></code> in <code class="docutils literal notranslate"><span class="pre">mache.spack</span></code> to generate and
test the environment and load scripts.</p></li>
<li><p>Confirm that the generated shell snippet includes the expected module loads
from the CIME machine config and that Spack detects all external packages.</p></li>
<li><p>Build and run a simple test application to verify the environment.</p></li>
</ol>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>For the non-spack aspects of adding a new machine, see <a class="reference internal" href="adding_new_machine.html"><span class="std std-doc">Adding a New Machine to Mache</span></a>.</p></li>
<li><p>For more details on Spack external packages, see the <a class="reference external" href="https://spack.readthedocs.io/en/latest/build_settings.html#external-packages">Spack documentation on external packages</a>.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="adding_new_machine.html" class="btn btn-neutral float-left" title="Adding a New Machine to Mache" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="building_docs.html" class="btn btn-neutral float-right" title="Building the Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Energy Exascale Earth System Model Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
   

  <!-- Meta tags for JS to use -->
  <meta name="doc-version" content="main">
  <meta name="doc-site-root" content="../">

  <!-- Create version switcher container -->
  <script>
    const sidebar = document.querySelector('.wy-side-nav-search');
    if (sidebar) {
      const versionDiv = document.createElement('div');
      versionDiv.id = 'version-switcher';
      versionDiv.style.marginTop = '1em';
      sidebar.appendChild(versionDiv);
    }
  </script>

  <!-- Load version-switcher.js using the correct relative path -->
  <script src="../../shared/version-switcher.js"></script>


</body>
</html>